# NewsFeed

## 1. **Выбор темы**
- Аналог новостной ленты социальной сети vk.com - NewsFeed
## 2. **Определение возможного диапазона нагрузок подобного проекта**
Примечание: так как сервис новостной ленты входит в vk.com, то можно считать что количество посещений vk.com в целом равно количеству посещений сервиса новостной ленты. Отличие будет в том, сколько в среднем времени проводится пользователем в новостной ленте относительно всего приложения/других сервисов vk.com
- Дневная аудитория - [43.3% населения России](https://popsters.ru/blog/post/svezhie-dannye-o-vk) - 62 млн пользователей
- Месячная аудитория - [71.8% населения России](https://popsters.ru/blog/post/svezhie-dannye-o-vk) - 104 млн пользователей
- [30 минут в день](https://www.emarketer.com/content/emarketer-reduces-us-time-spent-estimates-for-facebook-and-snapchat) - столько среднестатистический пользователь проводит время в новостной ленте

## 3. **Выбор планируемой нагрузки - 50% доля рынка России**
Самые крупные сервисы:
- Vk.com - 43.3% - 62 млн ежедн.
- Instagram - 26.9% - 39 млн ежедн.
- Ok.ru - 16.9% - 24 млн ежедн. 
Планируемая нагрузка - 49.6% ~ 50% доля рынка в России.

[Источник: Mediascope](https://popsters.ru/blog/post/svezhie-dannye-o-vk)

Новостная лента у всех пользователей очень и очень разная. Посты ленты могут состоять как из текста, так и из музыки и видео. Наш MVP будет состоять только из текста и картинок.
2) В среднем одно изображение из ленты занимает 150 Кб, за минуту можно посмотреть около 12 изображений, где на каждую картинку уйдет ~ 5 секунд просмотра. Получаем 12 изобр * 150 Кб * 60 = 144000 Кб за час = 100Мб за час
4) Текстовые посты как и простые сообщения занимают от [2 до 10 Мб](https://teztele.com/skolko-internet-trafika-potreblyayut-populyarnye-prilozheniya/) за час, возьмем 5 Мб.
Теперь пусть новостная лента равномерно распределяет аудио, изобрежения, видео и текст. (100 Мб + 5 мб) / 2 = 52.5 Мб за час.
### Посчитаем дневную нагрузку:
- 62 млн * (30 минут / 60 минут) * 52.5 Мб = 1552 Тб в день. 
### За секунду:
- 1552 / 86400  = 0.0179 Тб/с ~ 18.4 Гб/с
- 80 Гб /с * 8 = 147 Гбит/с

## 4. ** Логическая схема базы данных (без выбора СУБД) **
Так как подборка фида операция дорогая, запросы будут тяжелые и кэширование мало чем поможет (так как посты друзей и групп меняются очень и очень часто), то целесообразно будет выбрать нереляционную базу данных с хранением JSON-подобных документов со всеми постами пользователя в рамках одного документа. Другими словами, так как пользователи на своей странице добавляют посты намного реже, чем это делают группы/сообщества, то посты самих пользователей можно хранить в документе пользователя. В базе данных будем намеренно хранить не полную информацию, информацию достаточную лишь для формирования фида. 

Небольшая оптимизация:
Есть так же смысл создать поле "last_post" для групп и пользователей, так как самая большая нагрузка на показ первых страниц новостей (примерно по 1 новому посту от каждого пользователя/группы) - чаще всего пользователи пролистывают новый контент, а когда долистывают до старого (который они уже читали) - выходят из сервиса новостей. 
 
![DB](./images/DB.png)

В то время, пока отображаются только "новые" новости от пользователей и групп, можно подгружать старые.
1) Для "новых" новостей:
Пусть U - количество друзей,  G - количество групп, на которые подписан пользователь. Подборка только "новых" новостей по одному на каждого пользователя/группы будет занимать:
O(U + G)

2) Остается подгружать остальную ленту.
Пусть U - количество друзей, N(Ui) - количество постов i-го пользователя, G - количество групп, на которые подписан пользователь, N(Gj) - количество постов j-го группы. Достать все новости займет:
O(U*N(Ui) + G*N(Gj))

Форфмирование фида для пользователей так же нагружает сервер, будем учитывать это при подсчете нагрузки.

Будем использовать пагинацию и показывать пользователю 20 постов на каждой странице.

## 5. ** Физическая системы хранения (конкретные СУБД, шардинг, расчет нагрузки, обоснование реализуемости на основе результатов нагрузочного тестирования) **
Рассчитаем RPS
``` 
62 000 0000 ежедневных пользователей
x
30 минут в сутки проводят пользователи
/
(60 сек * 60 мин * 24 ч) секунд в сутках
------------------------------------------
~ 21 527 RPS
``` 
